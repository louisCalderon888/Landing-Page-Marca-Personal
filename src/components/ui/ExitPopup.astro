---
/**
 * ExitPopup.astro
 * 
 * MARKETING PSYCHOLOGY TRIGGERS:
 * - Loss Aversion: Headline focuses on what they're losing by leaving
 * - Scarcity: Limited spots messaging (ethical - based on real capacity)
 * - Commitment & Consistency: Small ask first (email) before purchase
 * - Zeigarnik Effect: "Estás a un paso de..." creates open loop
 */
---

<!-- Exit Intent Popup Container -->
<div 
  id="exit-popup" 
  class="fixed inset-0 z-50 hidden items-center justify-center p-4"
  aria-hidden="true"
>
  <!-- Backdrop -->
  <div 
    class="absolute inset-0 bg-dark-950/90 backdrop-blur-sm transition-opacity duration-300"
    id="popup-backdrop"
  ></div>
  
  <!-- Popup Card -->
  <div class="relative w-full max-w-md transform transition-all duration-300 scale-95 opacity-0" id="popup-card">
    <div class="premium-card p-8 border border-dark-700 shadow-2xl">
      <!-- Close Button -->
      <button 
        id="popup-close"
        class="absolute top-4 right-4 text-dark-400 hover:text-white transition-colors"
        aria-label="Cerrar popup"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- Header with Loss Aversion -->
      <div class="text-center mb-6">
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-brand-amber/20 flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-brand-amber" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        
        <!-- Loss Aversion Headline -->
        <h3 class="text-2xl font-display font-bold text-white mb-2">
          ¿Vas a seguir perdiendo dinero <br/>
          <span class="text-brand-amber">operando con emociones?</span>
        </h3>
        
        <p class="text-dark-300 text-sm">
          El 90% de los traders pierde. La diferencia está en tener un sistema verificado.
        </p>
      </div>
      
      <!-- Scarcity Message (ethical - based on real capacity) -->
      <div class="flex items-center justify-center gap-2 mb-6 px-4 py-3 bg-brand-green/10 border border-brand-green/30 rounded-lg">
        <span class="pulse-dot"></span>
        <span class="text-brand-green text-sm font-medium">
          Solo <span class="font-bold">5 cupos</span> disponibles para mentoría este mes
        </span>
      </div>
      
      <!-- Zeigarnik Effect - Open Loop -->
      <p class="text-center text-dark-400 text-sm mb-6">
        Estás a un paso de acceder a un track record con <span class="text-brand-green font-semibold">94% ROI verificado</span>
      </p>
      
      <!-- CTA Form - Commitment (small ask first) -->
      <form id="popup-form" class="space-y-4">
        <div>
          <input 
            type="email" 
            name="email"
            placeholder="Tu mejor email"
            required
            class="w-full bg-dark-800 border border-dark-600 rounded-lg px-4 py-3 text-white placeholder-dark-400 focus:border-brand-blue focus:ring-2 focus:ring-brand-blue/20 focus:outline-none transition-all duration-200"
          />
        </div>
        
        <button 
          type="submit"
          class="w-full px-6 py-3 rounded-lg bg-gradient-to-r from-brand-blue to-brand-green text-white font-semibold hover:shadow-lg hover:shadow-brand-green/25 transition-all duration-300 btn-glow btn-glow-cta"
        >
          Quiero Dejar de Perder Dinero
        </button>
        
        <p class="text-xs text-dark-500 text-center">
          Sin spam. Solo información valiosa sobre trading sistemático.
        </p>
      </form>
      
      <!-- Pratfall Effect - Honesty builds trust -->
      <div class="mt-6 pt-4 border-t border-dark-800 text-center">
        <p class="text-xs text-dark-400 italic">
          "Mi peor drawdown fue -48%. ¿Cuál fue el del 'gurú' que sigues?"
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  // Exit Intent Detection
  const popup = document.getElementById('exit-popup');
  const popupCard = document.getElementById('popup-card');
  const backdrop = document.getElementById('popup-backdrop');
  const closeBtn = document.getElementById('popup-close');
  
  let hasShown = false;
  
  // Show popup when mouse leaves viewport (desktop exit intent)
  document.addEventListener('mouseleave', (e) => {
    if (e.clientY < 10 && !hasShown) {
      showPopup();
    }
  });
  
  // Also trigger after 60 seconds on mobile (scroll-based)
  let scrollTimeout: ReturnType<typeof setTimeout>;
  window.addEventListener('scroll', () => {
    if (hasShown) return;
    
    clearTimeout(scrollTimeout);
    const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
    
    // Show after scrolling 70% of the page
    if (scrollPercent > 70) {
      scrollTimeout = setTimeout(() => {
        if (!hasShown) showPopup();
      }, 3000);
    }
  });
  
  function showPopup() {
    // Check if already shown in this session
    if (sessionStorage.getItem('exitPopupShown')) return;
    
    hasShown = true;
    sessionStorage.setItem('exitPopupShown', 'true');
    
    popup?.classList.remove('hidden');
    popup?.classList.add('flex');
    
    setTimeout(() => {
      popupCard?.classList.remove('scale-95', 'opacity-0');
      popupCard?.classList.add('scale-100', 'opacity-100');
    }, 10);
  }
  
  function hidePopup() {
    popupCard?.classList.add('scale-95', 'opacity-0');
    popupCard?.classList.remove('scale-100', 'opacity-100');
    
    setTimeout(() => {
      popup?.classList.add('hidden');
      popup?.classList.remove('flex');
    }, 300);
  }
  
  closeBtn?.addEventListener('click', hidePopup);
  backdrop?.addEventListener('click', hidePopup);
  
  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') hidePopup();
  });
  
  // Form submission
  document.getElementById('popup-form')?.addEventListener('submit', (e) => {
    e.preventDefault();
    // Here you would integrate with your email service
    alert('¡Gracias! Te contactaremos pronto.');
    hidePopup();
  });
</script>

<style>
  .premium-card {
    background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
    backdrop-filter: blur(20px);
  }
  
  .pulse-dot {
    width: 8px;
    height: 8px;
    background: #10B981;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.5; transform: scale(1.2); }
  }
</style>
